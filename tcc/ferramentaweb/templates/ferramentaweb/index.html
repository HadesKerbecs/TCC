<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsicoSimula</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'ferramentasweb/styles.css' %}">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    
    <link rel="icon" href="{% static 'ferramentasweb/images/logo3.png' %}" type="image/png">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="barra-lateral">
            <img src="{% static 'ferramentasweb/images/logo1.png' %}" alt="Logo PsicoSimula" class="logo-title">
            <h1></h1>
            <div class="menu-item">
                <div class="button-container">
                    <button id="button-novocaso" type="button" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stack" viewBox="0 0 16 16">
                                <path d="m14.12 10.163 1.715.858c.22.11.22.424 0 .534L8.267 15.34a.6.6 0 0 1-.534 0L.165 11.555a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.66zM7.733.063a.6.6 0 0 1 .534 0l7.568 3.784a.3.3 0 0 1 0 .535L8.267 8.165a.6.6 0 0 1-.534 0L.165 4.382a.299.299 0 0 1 0-.535z"/>
                                <path d="m14.12 6.576 1.715.858c.22.11.22.424 0 .534l-7.568 3.784a.6.6 0 0 1-.534 0L.165 7.968a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0z"/>
                            </svg>
                        Gerar Novo Caso
                    </button>

                    <button type="button" class="btn btn-primary" id="button-historico">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-wechat" viewBox="0 0 16 16">
                                <path d="M11.176 14.429c-2.665 0-4.826-1.8-4.826-4.018 0-2.22 2.159-4.02 4.824-4.02S16 8.191 16 10.411c0 1.21-.65 2.301-1.666 3.036a.32.32 0 0 0-.12.366l.218.81a.6.6 0 0 1 .029.117.166.166 0 0 1-.162.162.2.2 0 0 1-.092-.03l-1.057-.61a.5.5 0 0 0-.256-.074.5.5 0 0 0-.142.021 5.7 5.7 0 0 1-1.576.22M9.064 9.542a.647.647 0 1 0 .557-1 .645.645 0 0 0-.646.647.6.6 0 0 0 .09.353Zm3.232.001a.646.646 0 1 0 .546-1 .645.645 0 0 0-.644.644.63.63 0 0 0 .098.356"/>
                                <path d="M0 6.826c0 1.455.781 2.765 2.001 3.656a.385.385 0 0 1 .143.439l-.161.6-.1.373a.5.5 0 0 0-.032.14.19.19 0 0 0 .193.193q.06 0 .111-.029l1.268-.733a.6.6 0 0 1 .308-.088q.088 0 .171.025a6.8 6.8 0 0 0 1.625.26 4.5 4.5 0 0 1-.177-1.251c0-2.936 2.785-5.02 5.824-5.02l.15.002C10.587 3.429 8.392 2 5.796 2 2.596 2 0 4.16 0 6.826m4.632-1.555a.77.77 0 1 1-1.54 0 .77.77 0 0 1 1.54 0m3.875 0a.77.77 0 1 1-1.54 0 .77.77 0 0 1 1.54 0"/>
                              </svg>
                        Histórico
                    </button>

                    <button type="button" class="btn btn-primary" id="button-compartilhar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-share" viewBox="0 0 16 16">
                                <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.5 2.5 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5m-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3"/>
                            </svg>
                        Compartilhar
                    </button>

                    <button type="button" class="btn btn-primary" id="button-personalizar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen-fill" viewBox="0 0 16 16">
                                <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001"/>
                            </svg>
                        Personalizar
                    </button>
                </div>
            </div>
            <div class="container-sobre">
                <div class="circulo-sobre">
                    <img src="{% static 'ferramentasweb/images/logo4.png' %}" alt="Ícone Logo" />
                </div>
                <h3>Sobre</h3>
                <p>Explore e gere casos clínicos hipotéticos para estudo em psicopatologia com o poder da inteligência artificial generativa. Encontre respostas e recursos que você precisa.</p>
            </div>
        </div>
        <div class="main-content">
            <h2>Casos Hipotéticos</h2>
            <img id="icone-central" src="{% static 'ferramentasweb/images/psicosimula.png' %}" alt="Ícone Central">
            <div id="janela-de-personalizacao" class="janela ocultar">
                <div class="modal-content">
                    <form id="customizar-formulario">
                        <span class="button-fechar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/>
                            </svg></span>
                        <h2 id="personalizarcaso">Personalize o Caso Clínico</h2>
                        
                        <div class="row-formulario">
                            <div class="grupo-formulario col-md-6">
                                <label for="idade" class="form-label">Faixa Etária</label>
                                <select id="idade" name="idade" class="form-select" aria-label="Selecione a faixa etária">
                                    <option value="" selected disabled>Selecione a faixa etária</option>
                                    <option value="Infância (0-12)">Infância (0-12 anos)</option>
                                    <option value="Adolescência (13-17 anos)">Adolescência (13-17 anos)</option>
                                    <option value="Jovem Adulto (18-25 anos)">Jovem Adulto (18-25 anos)</option>
                                    <option value="Adulto (26-59 anos)">Adulto (26-59 anos)</option>
                                    <option value="Idoso (60+ anos)">Idoso (60+ anos)</option>
                                </select>
                            </div>
            
                            <div class="grupo-formulario col-md-6">
                                <label for="sexo" class="form-label">Identidade de Gênero</label>
                                <select id="sexo" name="sexo" class="form-select" aria-label="Selecione o sexo">
                                    <option value="" selected disabled>Selecione a identidade</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Feminino">Feminino</option>
                                    <option value="Não Binário">Não Binário</option>
                                    <option value="Transgênero">Transgênero</option>
                                    <option value="Outro">Outro</option>
                                    <option value="Prefiro não informar">Prefiro não informar</option>
                                </select>
                            </div>
                        </div>
            
                        <label for="historico-medico">Histórico Clínico</label>
                        <textarea id="historico-medico" name="historico-medico" placeholder="Insira a histórica clínica do paciente"></textarea>
            
                        <label for="contexto-social">Contexto Social</label>
                        <textarea id="contexto-social" name="contexto-social" placeholder="Insira o contexto social do paciente"></textarea>

                        <label for="transtorno">Transtorno Psicológico</label>
                        <textarea id="transtorno" name="transtornoClinico" class="transtorno-area" placeholder="Digite o transtorno do paciente"></textarea>

                        <div class="grupo-formulario">
                            <label>Nível de Complexidade</label>
                            <div class="radio-group">
                                <div class="form-check radio-item">
                                    <input class="form-check-input" type="radio" name="nivel-complexidade" id="nivel-basico" value="Básico">
                                    <label class="form-check-label" for="nivel-basico">Básico</label>
                                </div>
                                <div class="form-check radio-item">
                                    <input class="form-check-input" type="radio" name="nivel-complexidade" id="nivel-intermediario" value="Intermediário">
                                    <label class="form-check-label" for="nivel-intermediario">Intermediário</label>
                                </div>
                                <div class="form-check radio-item">
                                    <input class="form-check-input" type="radio" name="nivel-complexidade" id="nivel-avancado" value="Avançado">
                                    <label class="form-check-label" for="nivel-avancado">Avançado</label>
                                </div>
                            </div>
                        </div>
                        <div class="buttons-container">
                        <button type="submit" class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-patch-check-fill" viewBox="0 0 16 16">
                                    <path d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89-.01.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.011a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89.01zm.287 5.984-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708.708"/>
                                  </svg>
                            Aplicar
                        </button>

                        <button type="submit" class="btn btn-primary button-resetar" >
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-x" viewBox="0 0 16 16" id="íconedoresetar">
                                    <path d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4m.256 7a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226-.341.496-.65.804-.918Q8.844 9.002 8 9c-5 0-6 3-6 4s1 1 1 1z"/>
                                    <path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m-.646-4.854.646.647.646-.647a.5.5 0 0 1 .708.708l-.647.646.647.646a.5.5 0 0 1-.708.708l-.646-.647-.646.647a.5.5 0 0 1-.708-.708l.647-.646-.647-.646a.5.5 0 0 1 .708-.708"/>
                                </svg>
                            Resetar
                        </button>
                        </div>
                    </form>
                </div>
            </div>
    
            <div class="chat-container">
                <div id="chat-box" class="ocultar">
                    <div>
                        <img src="{% static 'ferramentasweb/images/Brilho.png' %}" alt="Ícone Resultado" class="imagem-chat-box"/>
                    </div>
                </div>
                <div class="input-container">
                    <div class="agrupar-textarea">
                        <textarea id="user-input" placeholder="Informe o caso clínico"></textarea>
                    </button>
                    <button type="button" class="btn btn-primary" id="button-enviar" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                            <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
                        </svg>
                        Simular
                    </button>
                    </div>                    
                </div>
            </div>
        </div>

        <div id="historico-box" class="ocultar">
            <button class="button-fechar">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/>
                </svg>
            </button>
            <div id="informacoes-historico"></div>
        </div>
    </div>

    <input type="hidden" name="user_id" value="{{ user_id }}">
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatBox = document.getElementById('chat-box');
            const userInput = document.getElementById('user-input');
            const buttonEnviar = document.getElementById('button-enviar');
            const buttonNovoCaso = document.getElementById('button-novocaso');
            const buttonCompartilhar = document.getElementById('button-compartilhar');
            const buttonHistorico = document.getElementById('button-historico');
            const historicoBox = document.getElementById('historico-box');
            const informacoesHistorico = document.getElementById('informacoes-historico');
            const buttonFecharHistorico = document.querySelector('#historico-box .button-fechar');
            const buttonPersonalizar = document.getElementById('button-personalizar');
            const janelaPersonalizacao = document.getElementById('janela-de-personalizacao');
            const customizarButtonFechar = document.querySelector('#janela-de-personalizacao .button-fechar');
            const formularioCustomizar = document.getElementById('customizar-formulario');
            const buttonResetar = document.querySelector('.button-resetar');

            const idadeInput = document.getElementById('idade');
            const sexoInput = document.getElementById('sexo');
            const historicoMedicoInput = document.getElementById('historico-medico');
            const contextoSocialInput = document.getElementById('contexto-social');
            const transtornoClinico = document.getElementById('transtorno');
            const nivelComplexidadeInputs = document.querySelectorAll('input[name="nivel-complexidade"]');

            let isProcessing = false;
            let personalizacaoDados = {};

            function exibirModal(modal) {
                historicoBox.style.display = 'none';
                janelaPersonalizacao.style.display = 'none';
                chatBox.classList.add('ocultar');
                modal.style.display = 'block';
            }
        
            function fecharModals() {
                historicoBox.style.display = 'none';
                janelaPersonalizacao.style.display = 'none';
                chatBox.classList.remove('ocultar');
            }
            
            async function preencherCamposPersonalizacao() {
                try {
                    const response = await fetch("{% url 'personalizacao_dados' %}", {
                        method: 'GET',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
                    const data = await response.json();
        
                    if (data.personalizacao) {
                        idadeInput.value = data.personalizacao.idade || '';
                        sexoInput.value = data.personalizacao.sexo || '';
                        historicoMedicoInput.value = data.personalizacao.historico_medico || '';
                        contextoSocialInput.value = data.personalizacao.contexto_social || '';
                        transtornoClinico.value = data.personalizacao.transtorno || '';

                        nivelComplexidadeInputs.forEach(input => {
                            if (input.value === data.personalizacao.nivel_complexidade) {
                                input.checked = true;
                            }
                        });
                    }
                } catch (error) {
                    console.error(error);
                    alert('Ocorreu um erro ao carregar os dados de personalização.');
                }
            }

            buttonPersonalizar.addEventListener('click', function() {
                preencherCamposPersonalizacao();
                exibirModal(janelaPersonalizacao);
            });

            formularioCustomizar.addEventListener('submit', async function(event) {
                event.preventDefault();
            
                const idade = document.getElementById('idade').value;
                const sexo = document.getElementById('sexo').value;
                const historicoMedico = document.getElementById('historico-medico').value;
                const contextoSocial = document.getElementById('contexto-social').value;
                const transtornoClinico = document.getElementById('transtorno').value;
                const nivelComplexidade = document.querySelector('input[name="nivel-complexidade"]:checked').value;

                if (!nivelComplexidade) {
                    alert('Por favor, selecione um nível de complexidade.');
                    return;
                }
            
                const personalizacao = {
                    idade: idade,
                    sexo: sexo,
                    historico_medico: historicoMedico,
                    contexto_social: contextoSocial,
                    transtornoClinico: transtornoClinico,
                    nivel_complexidade: nivelComplexidade
                };
            
                try {
                    const response = await fetch("{% url 'personalizar_caso' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(personalizacao)
                    });
            
                    if (!response.ok) throw new Error('Erro ao aplicar personalização');
                    
                    const result = await response.json();
                    alert(result.message);
                    fecharModals();
                } catch (error) {
                    console.error(error);
                    alert('Ocorreu um erro ao tentar personalizar o caso clínico.');
                }
            });            

            buttonResetar.addEventListener('click', async function() {
                event.preventDefault();
                idadeInput.value = '';
                sexoInput.value = '';
                historicoMedicoInput.value = '';
                contextoSocialInput.value = '';
                transtornoClinico.value = '';
                nivelComplexidadeInputs.forEach(input => input.checked = false);
        
                try {
                    const response = await fetch("{% url 'resetar_personalizacao' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
        
                    if (!response.ok) throw new Error('Erro ao resetar personalização');
                    
                    const result = await response.json();
                    alert(result.message);
                } catch (error) {
                    console.error(error);
                    alert('Ocorreu um erro ao tentar resetar a personalização.');
                }
            });
        
            function compartilharConteudoConsulta() {
                const mensagens = chatBox.querySelectorAll('.message');
                let consultaConteudo = '';
        
                mensagens.forEach(mensagem => {
                    consultaConteudo += mensagem.textContent + '\n';
                });
        
                if (consultaConteudo.trim() === "") {
                    alert('Nenhuma consulta disponível para compartilhar.');
                    return;
                }
        
                if (navigator.share) {
                    navigator.share({
                        title: 'Consulta do PsicoSimula',
                        text: consultaConteudo.trim(),
                    })
                    .then(() => console.log('Consulta compartilhada com sucesso'))
                    .catch((error) => console.error('Erro ao compartilhar:', error));
                } else {
                    alert('O compartilhamento não é suportado neste dispositivo.');
                }
            }
        
            buttonCompartilhar.addEventListener('click', compartilharConteudoConsulta);
        
            function enviarMensagem() {
                if (isProcessing) return;

                const userMessage = userInput.value.trim();
                if (userMessage !== '') {
                    adicionarMensagemChat('user', userMessage);
                    processarMensagem(userMessage);
                    userInput.value = '';
                    buttonEnviar.disabled = true;
                    isProcessing = true;
                }
            }
        
            buttonEnviar.addEventListener('click', function() {
                fecharModals();
                enviarMensagem();
            });
            
            userInput.addEventListener('input', function() {
                if (!isProcessing) {
                    buttonEnviar.disabled = userInput.value.trim() === '';
                }
            });
        
            userInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    fecharModals();
                    enviarMensagem();
                }
            });
        
            function adicionarMensagemChat(sender, message) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', sender);
                messageElement.textContent = message;
                chatBox.appendChild(messageElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        
            async function processarMensagem(message, personalizacao = null) {
                try {
                    let endpoint = "{% url 'gerar_caso_stream' %}";
                    let bodyData = { user_input: message };
            
                    if (personalizacao) {
                        endpoint = "{% url 'personalizar_caso' %}";
                        bodyData = { ...personalizacao, user_input: message };
                    }
            
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(bodyData)
                    });
            
                    if (!response.ok) throw new Error('Network response was not ok');
            
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let textoAcumulado = '';
                    let botMessageElement = null;
            
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
            
                        const chunk = decoder.decode(value, { stream: true });
                        const parsedChunks = chunk.split('\n').filter(chunk => chunk.trim() !== '');
            
                        parsedChunks.forEach(parsedChunk => {
                            try {
                                const jsonChunk = JSON.parse(parsedChunk);
                                if (jsonChunk.response) {
                                    textoAcumulado = jsonChunk.response;
            
                                    if (!botMessageElement) {
                                        botMessageElement = document.createElement('div');
                                        botMessageElement.classList.add('message', 'bot');
                                        chatBox.appendChild(botMessageElement);
                                    }
                                    botMessageElement.textContent = textoAcumulado;
                                    chatBox.scrollTop = chatBox.scrollHeight;
                                } else if (jsonChunk.error) {
                                    adicionarMensagemChat('bot', jsonChunk.error);
                                }
                            } catch (error) {
                                adicionarMensagemChat('bot', "Erro ao processar a resposta do servidor.");
                            }
                        });
                    }
                    isProcessing = false;
                    buttonEnviar.disabled = userInput.value.trim() === '';
                } catch (error) {
                    adicionarMensagemChat('bot', "Erro ao se conectar com o servidor: " + error.message);
                    isProcessing = false;
                }
            }   
            
            function exibirHistorico() {
                const userId = document.querySelector('input[name="user_id"]').value;
                fetch(`/pegar_historico/?user_id=${userId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Dados recebidos do histórico:', data);

                        if (data.length > 0) {
                            let ultimaData = '';
                            informacoesHistorico.innerHTML = data.map((item, index) => {
                                
                                const dataAtual = new Date(item.timestamp);

                                const dataFormatada = dataAtual.toLocaleDateString();
                                const horaFormatada = dataAtual.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                                let formattedMessage = `<strong>Mensagem:</strong> ${item.message}`;
                                let formattedResponse = item.response 
                                    ? `<strong>Resposta:</strong> ${item.response}`
                                    : '<strong>Resposta:</strong> Sem resposta disponível';

                                let dataSeparada = '';
                                if (dataAtual !== ultimaData) {
                                    if (index !== 0) {
                                        dataSeparada = `<hr class="data-separada" />`;
                                    }
                                    ultimaData = dataFormatada;
                                    dataSeparada += `<h4 class="historico-data">${dataFormatada} - ${horaFormatada}</h4>`;
                                }

                                return `${dataSeparada}
                                        <div class="historico-mensagem">${formattedMessage}</div>
                                        <div class="historico-resposta">${formattedResponse}</div>`;
                            }).join('');
                        } else {
                            informacoesHistorico.innerHTML = '<p>Sem histórico disponível.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao obter histórico:', error);
                    });
            }

            buttonHistorico.addEventListener('click', function() {
                exibirModal(historicoBox);
                exibirHistorico();
            });           
        
            buttonFecharHistorico.addEventListener('click', function() {
                fecharModals();
            });
        
            historicoBox.addEventListener('click', function(event) {
                if (event.target === historicoBox) {
                    fecharModals();
                }
            });

             function limitarMensagensNoChat() {
                const mensagens = chatBox.querySelectorAll('.message');
            
                if (mensagens.length > 50) {
                    for (let i = 0; i < 10; i++) {
                        if (mensagens[i]) {
                            mensagens[i].remove();
                        }
                    }
                    console.log('10 mensagens mais antigas foram removidas.');
                }
            }            
            
            async function salvarHistorico(userId, message, response) {
                try {
                    const result = await fetch('/salvar_historico/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ user_id: userId, message: message, response: response })
                    });
            
                    const data = await result.json();
                    if (data.status === 'success') {
                        console.log('Histórico salvo com sucesso');
                        limitarMensagensNoChat();
                    } else {
                        console.error('Erro ao salvar histórico:', data.message);
                    }
                } catch (error) {
                    console.error('Erro ao realizar a requisição:', error);
                }
            }
        
            customizarButtonFechar.addEventListener('click', function() {
                fecharModals();
            });
        
            janelaPersonalizacao.addEventListener('click', function(event) {
                if (event.target === janelaPersonalizacao) {
                    fecharModals();
                }
            });
        
            function resetChatBox() {
                const chatBox = document.getElementById('chat-box');
                if (chatBox) {
                    const image = chatBox.querySelector('.imagem-chat-box');
                    const messages = chatBox.querySelectorAll('.message');
                    
                    messages.forEach(message => message.remove());
                }
            }
        
            buttonNovoCaso.addEventListener('click', function() {
                fecharModals();
                resetChatBox();
            });
        });         
    </script>
</body>
</html>